{% extends 'events/base.html' %}
{% load static widget_tweaks %}

{% block title %}Modifier l'√©v√©nement public{% endblock %}
{% block hero_title %}Modifier l'√©v√©nement public{% endblock %}

{% block content %}
<section class="dashboard-section py-5">
  <div class="container">
    <div class="event-card-glow p-4 mb-5">
      <div class="event-header" style="--accent:#03a9f4;">
        <i class="fas fa-edit me-2"></i>Modifier l'√©v√©nement public
      </div>

      <div class="event-body">
        <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
          {% csrf_token %}

          <!-- Aper√ßu de l'image actuelle -->
          {% if event.image %}
          <div class="mb-4">
            <label class="form-label text-light fw-bold">Image actuelle</label>
            <div class="current-image-preview">
              <img src="{{ event.image.url }}" alt="Image actuelle de {{ event.title }}" class="current-image">
              <div class="image-overlay">
                <span class="badge bg-info">Image actuelle</span>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- üñºÔ∏è Image de l'√©v√©nement -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-image me-2"></i>Image de l'√©v√©nement
            </label>
            <div class="image-upload-container">
              {{ form.image|add_class:"form-control-dark image-upload-input" }}
              <div class="image-upload-preview mt-3" id="imagePreview" style="display: none;">
                <img id="previewImage" class="upload-preview-image">
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearImagePreview()">
                  <i class="fas fa-times me-1"></i>Supprimer l'aper√ßu
                </button>
              </div>
            </div>
            <div class="form-text text-muted">
              T√©l√©chargez une nouvelle image pour votre √©v√©nement. Formats support√©s : JPG, PNG, WebP.
            </div>
          </div>

          <!-- üè∑Ô∏è Titre -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-heading me-2"></i>Titre de l'√©v√©nement
            </label>
            {{ form.title|add_class:"form-control-dark"|attr:"placeholder:Donnez un titre attractif √† votre √©v√©nement" }}
            {% if form.title.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.title.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- üìù Description -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-align-left me-2"></i>Description
            </label>
            {{ form.description|add_class:"form-control-dark"|attr:"rows:4"|attr:"placeholder:D√©crivez votre √©v√©nement en d√©tail..." }}
            {% if form.description.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.description.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- ‚è∞ Date et heure -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-calendar-alt me-2"></i>Date et heure
            </label>
            {{ form.date|add_class:"form-control-dark"|attr:"type:datetime-local" }}
            {% if form.date.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.date.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- üìç Lieu -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-map-marker-alt me-2"></i>Lieu
            </label>
            {{ form.location|add_class:"form-control-dark"|attr:"placeholder:O√π se d√©roulera votre √©v√©nement ?" }}
            {% if form.location.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.location.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- üîó Lien en ligne -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-link me-2"></i>Lien en ligne (optionnel)
            </label>
            {{ form.online_link|add_class:"form-control-dark"|attr:"placeholder:https://..." }}
            <div class="form-text text-muted">
              Pour les √©v√©nements en visioconf√©rence ou streaming.
            </div>
            {% if form.online_link.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.online_link.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- üí∞ Type d'√©v√©nement (Gratuit/Payant) -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-tag me-2"></i>Type d'√©v√©nement
            </label>
            <div class="event-type-selector">
              {{ form.is_paid|add_class:"form-control-dark" }}
            </div>
            <div class="form-text text-muted">
              Choisissez si votre √©v√©nement est gratuit ou payant.
            </div>
            {% if form.is_paid.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.is_paid.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- üíµ Prix (affich√© conditionnellement) -->
          <div class="mb-4" id="priceField" style="display: {% if event.is_paid %}block{% else %}none{% endif %};">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-money-bill-wave me-2"></i>Prix (DT)
            </label>
            {{ form.price|add_class:"form-control-dark"|attr:"placeholder:0.00"|attr:"step:0.01"|attr:"min:0" }}
            <div class="form-text text-muted">
              Prix par participant pour les √©v√©nements payants.
            </div>
            {% if form.price.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.price.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- üë• Participants maximum -->
          <div class="mb-4">
            <label class="form-label text-light fw-bold">
              <i class="fas fa-users me-2"></i>Nombre maximum de participants
            </label>
            {{ form.max_participants|add_class:"form-control-dark"|attr:"placeholder:Laisser vide pour illimit√©"|attr:"min:1" }}
            <div class="form-text text-muted">
              Limitez le nombre de participants ou laissez vide pour illimit√©.
            </div>
            {% if form.max_participants.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.max_participants.errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- Affichage des erreurs g√©n√©rales -->
          {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {% for error in form.non_field_errors %}
              {{ error }}
            {% endfor %}
          </div>
          {% endif %}

          <!-- Boutons d'action -->
          <div class="d-flex justify-content-between align-items-center mt-5 pt-4 border-top border-secondary">
            <div>
              <a href="{% url 'event_detail' 'public' event.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>Annuler
              </a>
            </div>
            <div class="btn-group">
              <a href="{% url 'delete_event' event.id %}" class="btn btn-outline-danger me-2">
                <i class="fas fa-trash me-2"></i>Supprimer
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Enregistrer les modifications
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Script pour la pr√©visualisation d'image et gestion du type d'√©v√©nement -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Pr√©visualisation d'image
  const imageInput = document.querySelector('.image-upload-input');
  const imagePreview = document.getElementById('imagePreview');
  const previewImage = document.getElementById('previewImage');
  
  if (imageInput) {
    imageInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        
        reader.addEventListener('load', function() {
          previewImage.src = reader.result;
          imagePreview.style.display = 'block';
        });
        
        reader.readAsDataURL(file);
      } else {
        imagePreview.style.display = 'none';
      }
    });
  }

  // Gestion de l'affichage du champ prix
  const eventTypeSelect = document.querySelector('select[name="is_paid"]');
  const priceField = document.getElementById('priceField');
  
  if (eventTypeSelect && priceField) {
    eventTypeSelect.addEventListener('change', function() {
      if (this.value === 'paid') {
        priceField.style.display = 'block';
        // Focus sur le champ prix quand il appara√Æt
        const priceInput = document.querySelector('input[name="price"]');
        if (priceInput) {
          setTimeout(() => priceInput.focus(), 100);
        }
      } else {
        priceField.style.display = 'none';
        // R√©initialiser le prix √† 0 pour les √©v√©nements gratuits
        const priceInput = document.querySelector('input[name="price"]');
        if (priceInput) {
          priceInput.value = '0';
        }
      }
    });
  }

  // Validation de la date
  const dateInput = document.querySelector('input[type="datetime-local"]');
  if (dateInput) {
    dateInput.addEventListener('change', function() {
      const selectedDate = new Date(this.value);
      const now = new Date();
      
      if (selectedDate < now) {
        alert('‚ö†Ô∏è La date de l\'√©v√©nement ne peut pas √™tre dans le pass√©.');
        this.value = '';
      }
    });
  }

  // Validation du prix pour les √©v√©nements payants
  const priceInput = document.querySelector('input[name="price"]');
  if (priceInput) {
    priceInput.addEventListener('change', function() {
      const eventType = eventTypeSelect ? eventTypeSelect.value : 'free';
      if (eventType === 'paid' && (this.value === '' || parseFloat(this.value) <= 0)) {
        alert('‚ö†Ô∏è Veuillez sp√©cifier un prix positif pour un √©v√©nement payant.');
        this.value = '';
        this.focus();
      }
    });
  }
});

function clearImagePreview() {
  const imageInput = document.querySelector('.image-upload-input');
  const imagePreview = document.getElementById('imagePreview');
  
  if (imageInput) {
    imageInput.value = '';
  }
  if (imagePreview) {
    imagePreview.style.display = 'none';
  }
}
</script>

<style>
.dashboard-section {
  background: rgba(0,0,0,0.85);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 0 25px rgba(138,95,255,0.15);
}

.event-card-glow {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 0 25px rgba(0,0,0,0.4);
  overflow: hidden;
  transition: all 0.3s ease;
}

.event-card-glow:hover {
  box-shadow: 0 0 30px rgba(3,169,244,0.3);
}

.event-header {
  background: linear-gradient(90deg, var(--accent), transparent);
  color: #fff;
  font-weight: 700;
  font-size: 1.4rem;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.event-body {
  padding: 1.5rem 2rem;
  color: #ddd;
}

.form-control-dark {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.1);
  color: #fff;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  transition: all 0.3s ease;
}

.form-control-dark:focus {
  background: rgba(255,255,255,0.15);
  border-color: #03a9f4;
  box-shadow: 0 0 10px rgba(3,169,244,0.5);
  color: #fff;
  outline: none;
}

.form-control-dark::placeholder {
  color: #aaa;
}

.form-label {
  color: #b0b9ff;
  margin-bottom: 0.5rem;
  display: block;
}

/* Styles pour l'aper√ßu d'image */
.current-image-preview {
  position: relative;
  max-width: 300px;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid rgba(3,169,244,0.3);
}

.current-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.image-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
}

.image-upload-preview {
  text-align: center;
  padding: 1rem;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  border: 2px dashed rgba(3,169,244,0.3);
}

.upload-preview-image {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  object-fit: cover;
}

/* Styles pour le s√©lecteur de type d'√©v√©nement */
.event-type-selector {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.event-type-option {
  flex: 1;
  min-width: 120px;
}

/* Boutons */
.btn {
  border-radius: 8px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.btn-primary {
  background: linear-gradient(135deg, #03a9f4, #0288d1);
  border-color: #03a9f4;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #0288d1, #0277bd);
  border-color: #0288d1;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(3,169,244,0.4);
}

.btn-outline-secondary {
  border-color: #6c757d;
  color: #6c757d;
}

.btn-outline-secondary:hover {
  background: #6c757d;
  border-color: #6c757d;
  color: #fff;
}

.btn-outline-danger {
  border-color: #dc3545;
  color: #dc3545;
}

.btn-outline-danger:hover {
  background: #dc3545;
  border-color: #dc3545;
  color: #fff;
}

/* Responsive */
@media (max-width: 768px) {
  .dashboard-section {
    padding: 1rem;
  }
  
  .event-body {
    padding: 1rem;
  }
  
  .d-flex.justify-content-between {
    flex-direction: column;
    gap: 1rem;
  }
  
  .btn-group {
    width: 100%;
    justify-content: center;
  }
  
  .event-type-selector {
    flex-direction: column;
  }
}

/* Animation pour les transitions */
#priceField {
  transition: all 0.3s ease-in-out;
}

/* Indicateurs de statut */
.alert {
  border-radius: 10px;
  border: none;
}

.alert-danger {
  background: rgba(220,53,69,0.1);
  color: #f8d7da;
  border-left: 4px solid #dc3545;
}
</style>
{% endblock %}